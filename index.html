<!DOCTYPE html>
<html>
<head>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
	 <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
</head>
<body >
	<header>
		<div class="container">
			<h1>Words on Pairs</h1>
		</div>
		<section id="menu" class="d-flex justify-content-center bg-dark">
			<nav class="navbar navbar-expand-md bg-dark navbar-dark container">
			  <a class="navbar-brand" href="/">Home</a>
			  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#collapsibleNavbar">
			    <span class="navbar-toggler-icon"></span>
			  </button>
			  <div class="collapse navbar-collapse" id="collapsibleNavbar">
			    <ul class="navbar-nav">
			      <li class="nav-item">
			        <a class="nav-link" href="#">Add new words on pair page</a>
			      </li>
			      <li class="nav-item">
			        <a class="nav-link" href="#">Link</a>
			      </li>
			      <li class="nav-item">
			        <a class="nav-link" href="#">Link</a>
			      </li>    
			    </ul>
			  </div>  
			</nav>
		</section>
	</header>
	<div class="container">
		<div class="row d-flex justify-content-center">
			<main class="col-sm-12 card">
				<div class="d-flex justify-content-center">
				<button class="btn btn-warning dropdown-toggle" type="button" data-toggle="collapse" data-target=".AddWords" aria-expanded="false" aria-controls="AddWords wordInsert" style="font-size: x-large;">Add Words</button>
			</div>
			<section class="collapse border-bottom AddWords" id="AddWords" style="font-size: x-large;">
				<div class="row card-body">
					<div class="form-group col-sm-6">
					    <label for="wordsToLearn">Words A</label>
					    <textarea class="form-control" id="wordsToLearn" rows="8" placeholder="pink 
yellow 
blue"></textarea>
					    </div>
					<div class="form-group col-sm-6">
					    <label for="wordsTranslated">Words B</label>
					    <textarea class="form-control" id="wordsTranslated" rows="8" placeholder="rosa
amarillo
azul"></textarea>
					</div>
				</div>
				<div class="row card-body">
					<label class="col-sm-12" for="wordA">Add new word</label>
					<div class="form-group col-sm-5">
						<input type="text" class="form-control" id="wordA"  placeholder="blue" required="">
					</div>
					<div class="form-group col-sm-5">
						<input type="text" class="form-control" id="wordB"  placeholder="azul" required="">
					</div>
					<div class="col-sm-2 d-flex justify-content-center">
						<button type="button" class="btn btn-success" onclick="addWord()" style="font-size: large;">Add word</button>
					</div>
				</div>
				<div class="alert alert-danger" id="wordsAddError" style="display: none;" role="alert">
				  The number of words must be the same.
				</div>
				<div class="alert alert-success" id="wordsAddSuccess" style="display: none;" role="alert">
				  Words added ! :)
				</div>
				<div class="d-flex justify-content-center">
					<button type="button" class="btn btn-success m-3" onclick="addWords()" style="font-size: x-large;"
					data-toggle="collapse" data-target=".AddWords" aria-expanded="false" aria-controls="AddWords wordInsert">Done!</button>
					<button type="button" class="btn btn-danger m-3" onclick="removeWords()" style="font-size: x-large;">Remove the words</button>
				</div>
			</section>
			<section class="card-body collapse AddWords show" id="wordInsert" >
				<div class="d-flex justify-content-center">
					<button class="btn btn-secondary dropdown-toggle" type="button" data-toggle="collapse" data-target="#options" aria-expanded="false" aria-controls="direction" style="font-size: x-large;">Options</button>
				</div>
				<section class="card row collapse" id="options">
					<section class="card-body col-sm-2 border-right align-items-center d-flex flex-column" id="direction">
						<h4>Direction</h4>
						<div class="form-check">
							<input class="form-check-input" type="radio" name="direction" id="direction2" value="2" checked>
							<label class="form-check-label" for="direction2">A ⇄ B</label>
						</div>
						<div class="form-check">
							<input class="form-check-input" type="radio" name="direction" id="direction0" value="0">
							<label class="form-check-label" for="direction0">A ➜ B</label>
						</div>
						<div class="form-check">
							<input class="form-check-input" type="radio" name="direction" id="direction1" value="1">
							<label class="form-check-label" for="direction1">B ➜ A</label>
						</div>
					</section>
				</section>
				<section id="wordInsert-correct" class="text-center" style="display: none; font-size: 2em;">
					<div class="form-group">
					    <label id="wordMessage" for="wordInserted"></label>
					    <!--<textarea class="form-control" id="wordInserted" rows="3"></textarea>-->
					    <input type="text" class="form-control" id="wordInserted"  placeholder="Enter here the reponse" style="font-size: xx-large;">
					</div>
					<div class="alert text-center" id="messageResult" style="display: none; font-size: large;" role="alert">
					</div>
					<div class="d-flex justify-content-center">
						<button type="button" id="correct-button" class="btn btn-success mb-2" onclick="correct()" style="font-size: xx-large;">Correct !</button>
					</div>
				</section>
				<div class="alert alert-danger" id="wordInsertError" style="font-size: xx-large;" role="alert"></div>
			</section>
			<div class="d-flex justify-content-center">
				<button class="btn btn-info dropdown-toggle" type="button" data-toggle="collapse" data-target="#Stats" aria-expanded="false" aria-controls="Stats" style="font-size: xx-large;">Stats</button>
			</div>
			<section class="collapse border-bottom Stats" id="Stats" style="font-size: large;">
				<section class="row justify-content-around mt-3">
					<table class="table col-5" id="WordAToB">
					  <thead>
					    <tr>
					      <th scope="col">Word</th>
					      <th scope="col">Correct</th>
					      <th scope="col">Wrong</th>
					      <th scope="col">Attempts</th>
					    </tr>
					  </thead>
					</table>
					<table class="table col-5" id="WordAToB">
					  <thead>
					    <tr>
					      <th scope="col">Word</th>
					      <th scope="col">Correct</th>
					      <th scope="col">Wrong</th>
					      <th scope="col">Attempts</th>
					    </tr>
					  </thead>
					</table>
				</section>
			</section>
						</main>
		</div>
	</div>
	<script type="text/javascript">
		String.prototype.replaceAll = function(search, replacement) {
		    var target = this;
		    return target.replace(new RegExp(search, 'gm'), replacement);
		};
		$.noConflict();
		var word;
		var wordsToLearnAux = null;
		var wordsTranslatedAux = null;
		var direction = null; // 0 = a ==> b, 1 = b ==> 
		let wordsAtoBRights = null;
		let wordsBtoARights = null;
		let wordsAtoBFails = null;
		let wordsBtoAFails = null;

		for(var pair of (new URL(window.location.href)).searchParams.entries()) {
		   document.getElementById('wordA').value = pair[0];
		   document.getElementById('wordB').value = pair[1];
		   addWord();
		}


		if(document.getElementById('wordsToLearn').value.length == 0)
			thereAreWords();
		else
			addWords(); 
		//thereAreWords();
		function normalize(input) {
			return input.toLowerCase().trim().replaceAll("á","a").replaceAll("ó","o").replaceAll("é","e").replaceAll("í","i").replaceAll("ú","u");
		}
		function addWord() {
			let wordsToLearn = document.getElementById('wordsToLearn');
			let wordsTranslated = document.getElementById('wordsTranslated');
			let wordA = document.getElementById('wordA');
			let wordB = document.getElementById('wordB');

			if(wordA.value.length > 0 && wordB.value.length > 0){
				wordsToLearn.value = (wordsToLearn.value + "\n" + wordA.value).replaceAll("^\n^","");
				wordsTranslated.value = (wordsTranslated.value + "\n" + wordB.value).replaceAll("^\n^","");
				document.getElementById('wordsAddError').style.display = "none";
				wordA.value = ""; 
				wordA.focus();
				wordB.value = ""; 
			}else{
				document.getElementById("wordsAddError").innerHTML = "You have to add the words in pairs";	
				document.getElementById("wordsAddError").style.display = "block";
				if (wordA.value.length == 0) {
					wordA.focus();
				}else{
					wordB.focus();
				}
			}
			
		}
		function addWords() {
			document.getElementById("wordsAddError").style.display = "none";
			document.getElementById("wordsAddSuccess").style.display = "none";
			wordsToLearnAux = null; 
			wordsTranslatedAux = null; 
			if (document.getElementById('wordsToLearn').value.split("\n").length != document.getElementById('wordsTranslated').value.split("\n").length) {
				document.getElementById("wordsAddError").style.display = "block";
				thereAreWords();
			} else {
				document.getElementById("wordsAddSuccess").style.display = "block";
				let wordsToLearn = document.getElementById('wordsToLearn').value.replaceAll("\n","{**}").replaceAll(/(\{\**\})+$/,"");
				let wordsTranslated = document.getElementById('wordsTranslated').value.replaceAll("\n","{**}").replaceAll(/(\{\**\})+$/,"");

				wordsToLearnAux = wordsToLearn.split("{**}");
				wordsTranslatedAux = wordsTranslated.split("{**}");

				wordsToLearn = wordsToLearn.replaceAll(/\{\*\*\}/,"\n"); 
				wordsTranslated = wordsTranslated.replaceAll(/\{\*\*\}/,"\n");
				document.getElementById('wordsToLearn').value = wordsToLearn;
				document.getElementById('wordsTranslated').value = wordsTranslated;
				//console.log(wordsToLearn);
				//console.log(wordsTranslated);
				//localStorage.setItem('wordsToLearn', wordsToLearn);
				//localStorage.setItem('wordsTranslated', wordsTranslated);
				wordsAtoBRights = new Array();
				wordsBtoARights = new Array();
				wordsAtoBFails = new Array();
				wordsBtoAFails = new Array();
				for (let i = 0; i < wordsTranslatedAux.length; i++) {
					wordsAtoBRights[i] = 0;
					wordsBtoARights[i] = 0;
					wordsAtoBFails[i] = 0;
					wordsBtoAFails[i] = 0;
				}
				thereAreWords();
				generateNewWord()
			}
			
			
			
		}
		function removeWords() {
			document.getElementById('wordsToLearn').value = "";
			document.getElementById('wordsTranslated').value = "";
			wordsToLearnAux = null; 
			wordsTranslatedAux = null;
			//thereAreWords();
		}
		function thereAreWords() {
			document.getElementById('wordInsert-correct').style.display = "none";
			if (wordsToLearnAux == null || wordsTranslatedAux == null) {
				document.getElementById("wordInsertError").innerHTML = "You haven't added any words yet.";	
				document.getElementById("wordInsertError").style.display = "block";
				//document.getElementById('wordInserted').style.display = "none";
				//document.getElementById('correct-button').style.display = "none";
			} else {
				document.getElementById("wordInsert-correct").style.display = "block";
				document.getElementById('wordInsertError').style.display = "none";
				generateNewWord(); 
			}
		}
		document.getElementById('wordInserted').addEventListener("keyup", function(event) {
		  // Number 13 is the "Enter" key on the keyboard
		  if (event.keyCode === 13) {
		    // Cancel the default action, if needed
		    event.preventDefault();
		    correct();
		  }
		});

		function generateStats() {
			let stats = "";

			stats += `<section class="row justify-content-around mt-3">
					<table class="table col-5 table-hover" id="WordAToB">
					  <thead class="thead-light">
					    <tr>
					      <th scope="col">Word</th>
					      <th scope="col">Rights</th>
					      <th scope="col">Fails</th>
					      <th scope="col">Attempts</th>
					    </tr>
					  </thead>
					  <tbody>`

			let rights = 0; 
			let fails = 0;
			for (var i = 0; i < wordsToLearnAux.length; i++) {
				stats += `
							<tr>
								<th>${wordsToLearnAux[i]} ➜ ${wordsTranslatedAux[i]}</th>
								<th>${wordsAtoBRights[i]}</th>
								<th>${wordsAtoBFails[i]}</th>
								<th>${wordsAtoBRights[i] + wordsAtoBFails[i]}</th>
							</tr>
				`
				rights += wordsAtoBRights[i];
				fails += wordsAtoBFails[i];
			}

    		stats +=`
    				  </tbody>
    				  <tfoot>
    				  		<tr>
								<th>Total</th>
								<th>${rights}</th>
								<th>${fails}</th>
								<th>${rights + fails}</th>
							</tr>
    				  </tfoot>
					</table>
					<table class="table col-5 table-hover" id="WordAToB">
					  <thead class="thead-light">
					    <tr>
					      <th scope="col">Word</th>
					      <th scope="col">Rights</th>
					      <th scope="col">Fails</th>
					      <th scope="col">Attempts</th>
					    </tr>
					  </thead>
					  <tbody>`;
					  rights = 0; 
					  fails = 0;
					  for (var i = 0; i < wordsToLearnAux.length; i++) {
						stats += `
									<tr>
										<th>${wordsTranslatedAux[i]} ➜ ${wordsToLearnAux[i]}</th>
										<th>${wordsBtoARights[i]}</th>
										<th>${wordsBtoAFails[i]}</th>
										<th>${wordsBtoARights[i] + wordsBtoAFails[i]}</th>
									</tr>
						`
						rights += wordsBtoARights[i];
						fails += wordsBtoAFails[i];
					}
			stats +=` <tfoot>
    				  		<tr>
								<th>Total</th>
								<th>${rights}</th>
								<th>${fails}</th>
								<th>${rights + fails}</th>
							</tr>
    				  </tfoot>
					</table>
				</section>`; 

			jQuery("#Stats").empty();
			jQuery("#Stats").append(stats);


		}
		function correct() {
			let wordInserted = document.getElementById('wordInserted').value;

			let messageResult = document.getElementById("messageResult");
			messageResult.classList.remove("alert-success")
			messageResult.classList.remove("alert-danger")
			let isCorrect = false; 
			if(direction == 0){
				isCorrect = normalize(wordsTranslatedAux[word]).localeCompare(normalize(wordInserted)) == 0;
				if(isCorrect){
					wordsAtoBRights[word] += 1;
				}else{
					wordsAtoBFails[word] += 1;
				}
			}else{
				isCorrect = normalize(wordsToLearnAux[word]).localeCompare(normalize(wordInserted)) == 0;
				if(isCorrect){
					wordsBtoARights[word] += 1;
				}else{
					wordsBtoAFails[word] += 1;
				}
			}
			if(isCorrect){
				messageResult.innerHTML = "That's correct! " + wordsTranslatedAux[word] + " is " + wordsToLearnAux[word];
				messageResult.classList.add("alert-success")
			}else{
				messageResult.innerHTML = "Sorry but <strong>" + wordsTranslatedAux[word] + "</strong> is <strong>" + wordsToLearnAux[word] + "</strong>.";	
				messageResult.classList.add("alert-danger")
			}
			messageResult.style.display = "block";
			document.getElementById('wordInserted').value = "";
			document.getElementById('wordInserted').focus();
			generateNewWord();
		}
		function generateNewWord() {

			generateStats();
			word = Math.floor(Math.random() * wordsToLearnAux.length);

			document.getElementsByName("direction").forEach(element => {
				if (element.checked) {
					direction = element.value;
					console.log(direction);
				}
			});
			if(direction == 2)
				direction = Math.floor(Math.random() * 10) % 2 == 0;
			if (direction == 0) {
				let wordMessage = document.getElementById('wordMessage').innerHTML = normalize(wordsToLearnAux[word]);
			}else{
				let wordMessage = document.getElementById('wordMessage').innerHTML = normalize(wordsTranslatedAux[word]);
			}
			
		}
</script>	
	</body>
</html>